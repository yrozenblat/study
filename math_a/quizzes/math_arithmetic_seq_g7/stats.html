<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>סטטיסטיקה</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: center; }
    th { background: #f0f0f0; }
    .strength-rare { background: #ffe4b5; }
    .strength-weak { background: #ffcccc; }
    .strength-medium { background: #fff3cd; }
    .strength-strong { background: #d4edda; }
    #controls { margin-bottom: 10px; }
  </style>
  <script src="../../quiz_core/storage.js"></script>
  <script src="../../quiz_core/strength.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <h2>סטטיסטיקה</h2>
  <div id="controls">
    <button onclick="loadStats()">רענן</button>
    <button onclick="resetStats()">איפוס סטטיסטיקה</button>
  </div>
  <table id="statsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>שאלה</th>
        <th>נכונות</th>
        <th>סך הכל</th>
        <th>% הצלחה</th>
        <th>חוזק</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let QUIZ_ID = null;
    let QUESTIONS = [];
    let CONFIG = null;

    async function initPage() {
      try {
        const cfgResp = await fetch('quiz_config.json', { cache: 'no-store' });
        CONFIG = await cfgResp.json();
        QUIZ_ID = CONFIG.quizId || QUIZ_ID || 'unknown_quiz';
        const title = 'סטטיסטיקה – ' + (CONFIG.title || QUIZ_ID);
        document.title = title;
        const h2 = document.querySelector('h2');
        if (h2) h2.textContent = title;

        const qResp = await fetch('questions.json', { cache: 'no-store' });
        QUESTIONS = await qResp.json();
      } catch (e) {
        console.error('Failed to init stats page', e);
      }
    initPage();
    }


    
    async function loadStats() {
      const stats = StudyStorage.getQuizStats(QUIZ_ID);
      const resp = await fetch('questions.json', { cache: 'no-store' });
      const data = await resp.json();

      const tbody = document.querySelector('#statsTable tbody');
      tbody.innerHTML = '';

      // Support both flat questions[] and units[] with parts[].
      const rows = [];
      if (Array.isArray(data) && data.length && (data[0].parts && Array.isArray(data[0].parts))) {
        data.forEach((u) => {
          const unitId = u.unitId || u.id || '';
          const a1 = u?.data?.a1;
          const d = u?.data?.d;
          (u.parts || []).forEach((p) => {
            const partId = p.partId || p.id || '';
            const qid = unitId + '::' + partId;
            rows.push({
              qid,
              unitId,
              display: `a1=${a1}, d=${d}`,
              prompt: p.prompt || p.heText || ''
            });
          });
        });
      } else {
        (data || []).forEach((q) => {
          rows.push({ qid: q.id, unitId: '', display: '', prompt: q.heText || q.text || q.question || q.tex || '' });
        });
      }

      rows.forEach((row, idx) => {
        const s = stats[row.qid] || {correct: 0, total: 0};
        const ratio = s.total ? (s.correct / s.total) : 0;
        const strength = (typeof Strength !== 'undefined') ? Strength.classifyLegacy(s, CONFIG || {}) : 'rare';

        const tr = document.createElement('tr');
        tr.className = 'strength-' + strength;

        const tdIdx = document.createElement('td');
        tdIdx.textContent = String(idx + 1);
        tr.appendChild(tdIdx);

        const tdQ = document.createElement('td');
        tdQ.style.textAlign = 'right';
        tdQ.innerHTML = row.unitId
          ? `<div><b>${row.unitId}</b> <span dir="ltr" style="unicode-bidi:isolate">${row.display}</span></div><div>${row.prompt}</div>`
          : `<div>${row.prompt}</div>`;
        tr.appendChild(tdQ);

        const tdC = document.createElement('td');
        tdC.textContent = String(s.correct || 0);
        tr.appendChild(tdC);

        const tdT = document.createElement('td');
        tdT.textContent = String(s.total || 0);
        tr.appendChild(tdT);

        const tdR = document.createElement('td');
        tdR.textContent = s.total ? Math.round(ratio * 100) + '%' : '0%';
        tr.appendChild(tdR);

        const tdS = document.createElement('td');
        tdS.textContent = strength;
        tr.appendChild(tdS);

        tbody.appendChild(tr);
      });

      if (window.MathJax) {
        try { MathJax.typesetPromise(); } catch (_) {}
      }
    }


    function resetStats() {
      const code = prompt('סיסמה לאיפוס סטטיסטיקה:');
      if (code === '333') {
        StudyStorage.resetQuiz(QUIZ_ID);
    initPage();
      } else if (code !== null) {
        alert('קוד שגוי');
      }
    }
    initPage();
  </script>
</body>
</html>