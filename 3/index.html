<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>מערכת מבחנים</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; direction: rtl; }
#menu button { margin: 5px; }
hr { margin: 15px 0; }
</style>
</head>
<body>
<h2>מערכת מבחנים</h2>
<div id="menu"></div>
<hr>
<div id="quizArea">טוען קונפיג...</div>

<script type="module">
import { loadProgress } from './storage.js';
import { selectItems } from './selection.js';
import { renderVocabDragQuiz } from './quiz_vocab_drag.js';

let globalConfig = null;

async function init() {
  const qa = document.getElementById('quizArea');
  try {
    const res = await fetch('quizzes_config.json');
    if (!res.ok) throw new Error('quizzes_config.json status ' + res.status);
    globalConfig = await res.json();

    const menu = document.getElementById('menu');
    globalConfig.quizzes.filter(q => q.enabled).forEach(q => {
      const btn = document.createElement('button');
      btn.textContent = q.title;
      btn.onclick = () => loadQuiz(q.id);
      menu.appendChild(btn);
    });

    qa.textContent = 'בחר מבחן';
  } catch (e) {
    qa.textContent = 'שגיאה בטעינת הקונפיג: ' + e.message;
    console.error(e);
  }
}

async function loadQuiz(quizId) {
  const qa = document.getElementById('quizArea');
  const q = globalConfig.quizzes.find(x => x.id === quizId);
  if (!q) {
    qa.textContent = 'לא נמצא מבחן עם מזהה ' + quizId;
    return;
  }
  qa.textContent = 'טוען שאלות...';

  try {
    const res = await fetch(q.questionsFile);
    if (!res.ok) throw new Error(q.questionsFile + ' status ' + res.status);
    const data = await res.json();

    let items;
    if (Array.isArray(data)) {
      items = data.map((w, idx) => ({
        id: w.id || ('w' + String(idx+1).padStart(3,'0')),
        english: w.english,
        hebrew: w.hebrew
      }));
    } else if (Array.isArray(data.items)) {
      items = data.items;
    } else {
      throw new Error('מבנה JSON לא מוכר בקובץ ' + q.questionsFile);
    }

    const progress = loadProgress(q.id);
    const selected = selectItems(items, progress, q.numQuestions, q.selectionWeights);

    if (q.type === 'vocab_drag') {
      renderVocabDragQuiz(qa, q, selected, progress);
      qa.addEventListener('quiz:newTest', ev => {
        if (ev.detail.quizId === q.id) {
          loadQuiz(q.id);
        }
      }, { once: true });
    } else {
      qa.textContent = 'סוג מבחן אינו נתמך עדיין: ' + q.type;
    }
  } catch (e) {
    qa.textContent = 'שגיאה בטעינת השאלות: ' + e.message;
    console.error(e);
  }
}

init();
</script>
</body>
</html>
