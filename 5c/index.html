<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>מערכת מבחנים באנגלית</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
    h1 { margin-top: 0; }
    #selector { margin-bottom: 15px; }
    iframe { width: 100%; height: 600px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>מערכת מבחנים באנגלית</h1>
  <div id="selector">
    <label for="quizSelect">בחר מבחן:</label>
    <select id="quizSelect">
      <option value="vocab">אוצר מילים</option>
      <option value="quizzes/a_an/quiz.html">a / an</option>
      <option value="quizzes/am_is_are/quiz.html">am / is / are</option>
      <option value="quizzes/there_is_are/quiz.html">There is / There are</option>
    </select>

    <div id="vocabOptions" style="display:none; margin-top:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
      <div style="margin-bottom:10px;">
        <span style="font-weight:600;">סוג:</span>
        <label style="margin-inline-start:10px;"><input type="radio" name="vocabMode" value="drag" checked> מחסן (גרירה)</label>
        <label style="margin-inline-start:10px;"><input type="radio" name="vocabMode" value="open"> פתוח</label>
      </div>

      <div id="tagBox" style="margin-top:8px;">
        <div style="font-weight:600; margin-bottom:6px;">תגיות (הצג רק מילים מתוייגות):</div>
        <div id="tagList" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
      </div>
    </div>
  </div>
  <iframe id="quizFrame" src="quizzes/vocab/quiz.html?mode=drag"></iframe>

  <script>
    const sel = document.getElementById('quizSelect');
    const frame = document.getElementById('quizFrame');
    const vocabOptions = document.getElementById('vocabOptions');
    const tagList = document.getElementById('tagList');

    let vocabTags = [];

    async function loadVocabTagsOnce() {
      if (vocabTags.length) return vocabTags;
      try {
        const questions = await fetch('quizzes/vocab/questions.json').then(r => r.json());
        const set = new Set();
        questions.forEach(q => (q.tags || []).forEach(t => set.add(t)));
        vocabTags = Array.from(set).sort((a,b) => a.localeCompare(b, 'he'));
      } catch (e) {
        vocabTags = [];
      }
      return vocabTags;
    }

    function getSelectedVocabMode() {
      const r = document.querySelector('input[name="vocabMode"]:checked');
      return r ? r.value : 'drag';
    }

    function getSelectedTags() {
      const checked = Array.from(document.querySelectorAll('#tagList input[type="checkbox"]:checked'));
      return checked.map(c => c.value);
    }

    function updateFrame() {
      if (sel.value === 'vocab') {
        const mode = getSelectedVocabMode();
        const tags = getSelectedTags();
        const tagParam = tags.length ? ('&tags=' + encodeURIComponent(tags.join(','))) : '';
        frame.src = 'quizzes/vocab/quiz.html?mode=' + encodeURIComponent(mode) + tagParam;
      } else {
        frame.src = sel.value;
      }
    }

    async function showVocabOptions(show) {
      vocabOptions.style.display = show ? 'block' : 'none';
      if (show) {
        const tags = await loadVocabTagsOnce();
        tagList.innerHTML = '';
        if (!tags.length) {
          document.getElementById('tagBox').style.display = 'none';
        } else {
          document.getElementById('tagBox').style.display = 'block';
          tags.forEach(t => {
            const label = document.createElement('label');
            label.style.display = 'inline-flex';
            label.style.alignItems = 'center';
            label.style.gap = '6px';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = t;
            cb.addEventListener('change', updateFrame);
            label.appendChild(cb);
            const span = document.createElement('span');
            span.textContent = t;
            label.appendChild(span);
            tagList.appendChild(label);
          });
        }
      }
    }

    sel.addEventListener('change', async () => {
      await showVocabOptions(sel.value === 'vocab');
      updateFrame();
    });

    document.addEventListener('change', (e) => {
      if (e.target && e.target.name === 'vocabMode') updateFrame();
    });

    // initial
    (async () => {
      await showVocabOptions(true);
      updateFrame();
    })();
  </script>
</body>
</html>
